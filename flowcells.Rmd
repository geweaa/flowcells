---
title: "Flowcells Äspö HRL"
subtitle: "Biofilm formation in deep biosphere at Äspö HRL"
author: "George Westmeijer"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: spacelab
    highlight: textmate
    df_print: paged
    code_folding: hide
    self_contained: false
    keep_md: false
    encoding: "UTF-8"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
```


## Define theme and function(s)

```{r themes}
source("/Users/geweaa/Box Sync/Protocols/theme.R")
source("/Users/geweaa/Box Sync/Protocols/barplot.R")
```

## Read files


```{r input files, message=FALSE, warning=FALSE}
read_tsv('smd.tsv', col_types = cols(.default = col_character(),
                                     env = col_factor(levels = 
                                                        c("Planktonic MM-171.3","Biofilm MM-171.3",
                                                          "Planktonic TM-448.4","Biofilm TM-448.4")),
                                     treat = col_factor(levels = c(
                                       "A","B","C","D"
                                     ))
                                     )
         ) -> smd

read_tsv("taxonomy.tsv", col_types = cols(.default = col_character())) %>%
  mutate(order = if_else(order == "Betaproteobacteriales","Nitrosomonadales",order)) %>%
  mutate(class = if_else(order == "Nitrosomonadales","Betaproteobacteria",class)) %>%
  mutate(family = if_else(family == "Hydrogenophilaceae","Thiobacillaceae",family)) %>%
  mutate(order = if_else(family == "Burkholderiaceae","Burkholderiales",order)) %>%
  mutate(class = if_else(phylum == "Epsilonbacteraeota", "Epsilonproteobacteria", class)) %>%
  mutate(phylum = if_else(phylum == "Epsilonbacteraeota", "Proteobacteria",phylum))-> tax

read_tsv('seqtab.tsv', col_types = cols(.default = col_character(), count = col_integer())) %>%
  # Filter out samples with less than 1000 reads
  group_by(sample) %>% filter(sum(count) > 1000) %>%
  # Calculate relative abundance within sample
  mutate(relab = count / sum(count)) %>% ungroup() %>%
  # Average the relative abundance within an environment by dividing by the total
  inner_join(smd, by = 'sample') %>%
  mutate(env = if_else(nature == "Planktonic", as.vector(env), paste(env,age))) %>%
  group_by(env) %>% mutate(relab = relab / sum(relab)) %>% ungroup() %>%
  select(sample, seqid, count, relab) -> seqtab
```


## Rarefaction


```{r rarefaction}
seqtab %>%
  inner_join(smd, by = 'sample') %>%
  group_by(env, seqid) %>% summarise(count = sum(count), .groups = 'drop') %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames('env') -> seqtab_matrix

min(rowSums(seqtab_matrix)) %>%
vegan::rarecurve(seqtab_matrix, sample = ., step = 100, xlab = 'Sequencing depth (No. reads)', ylab = 'Diversity (No. ASVs)', label = TRUE)
```


## Alpha diversity using Shannon-Weaver index


```{r calculcate Shannon, message=FALSE, warning=FALSE}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>% column_to_rownames('sample') %>%
  vegan::diversity() %>% as.data.frame() %>% 
  gather(seqid, shannon, -1) %>%
  rename(shannon = 1) %>%
  rownames_to_column('sample') %>%
  inner_join(smd, by = "sample") %>% as_tibble() -> adiv
```


```{r statistics alpha diversity}
adiv %>% group_by(env,treat,age) %>% summarise(meandiv = mean(shannon), .groups = "drop") -> stat

suppressPackageStartupMessages(library(car))
# Normality of the data (null hypothesis data is normally distributed)
shapiro.test(stat$meandiv)
# Preferably all the dots on the diagonal
qqPlot(stat$meandiv)
# Homogeneity of variance using Levene (null hypothesis variance is equal)
leveneTest(meandiv ~ env, data = stat)
# Run ANOVA (null hypothesis diversity is equal)
aov(shannon ~ env, data = adiv) %>% summary()
# Post-hoc
aov(meandiv ~ env, data = stat) %>% TukeyHSD()
```


Plot alpha diversity


```{r plot adiv}
adiv %>%
  mutate(age = if_else(nature == "Planktonic", "", gsub("d"," d", age))) %>%
  ggplot(aes(x = shannon, y = fct_rev(env))) +
  geom_boxplot(outlier.color = "white") +
  geom_jitter(width = 0.01, stroke = 0.8, size = 1, fill = "white", shape = 21, height = 0.1) +
  labs(x = "Alpha diversity (Shannon index)", y = "") +
  scale_x_continuous(limits = c(1,6), expand = c(0.004,0), breaks = ) +
  scale_y_discrete(labels = 
                     c("Biofilm TM-448.4","Planktonic TM-448.4","Biofilm MM-171.3","Planktonic MM-171.3")
                   ) +
  ggrepel::geom_text_repel(aes(label = age), color = "black",
                  box.padding = 0.3, 
                  max.overlaps = 10,
                  min.segment.length = 0.4,
                  size = 6/.pt) +
  annotate('text', x = 6, y = 4, size = 7 / .pt, label = "bold(italic(n)) == 12", parse = TRUE) +
  annotate('text', x = 5.07, y = 3, size = 7 / .pt, label = "bold(italic(n) == 6)", parse = TRUE) +
  annotate('text', x = 5.37, y = 2, size = 7 / .pt, label = "bold(italic(n) == 12)", parse = T) +
  annotate('text', x = 5.13, y = 1, size = 7 / .pt, label = "bold(italic(n) == 6)", parse = T) +
  coord_cartesian(clip = "off") +
  theme_clean(ratio = 1.6, fontsize = 7) +
  theme(plot.tag.position = c(.2,1.01),
        plot.margin = margin(0,12,0,0),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype = "dotted", color = "grey", size = 0.3),
        axis.text.y.left = element_text(face = "bold"))  -> a
```


## Fig. 3b: NMDS on dataset DNA

```{r run nmds, results='hide'}
seqtab %>%
  group_by(seqid) %>% filter(count > 2) %>% ungroup() %>%
  select(seqid, sample, count) %>% spread(seqid, count, fill = 0) %>%
  column_to_rownames("sample") -> t

set.seed(999)
t %>%  vegan::metaMDS(trymax = 50, k = 2, autotransform = T) -> nmds
```

Extract the scores

```{r nmds.scores}
vegan::scores(nmds)$sites %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(smd, by = "sample") -> nmds.scores
```

Plot the ordination

```{r nmds plot, include = T}
nmds.scores %>% select(1:3) %>% inner_join(smd, by = "sample") -> t

#getting the convex hull of each unique point set
find_hull <- function(t) t[chull(t$NMDS1, t$NMDS2), ]
hulls <- plyr::ddply(t, "nature", find_hull)

nmds.scores %>%
  # Prepare data
  mutate(age = gsub("d"," d",age)) %>%
  mutate(age = ifelse(nature == "Planktonic" & age == "before", "b", age)) %>%
  mutate(age = ifelse(nature == "Planktonic" & age == "after", "a", age)) %>%
  # Plot
  ggplot(aes(x = NMDS1, y = NMDS2, fill = nature)) +
  geom_polygon(data = hulls, alpha = .3) +
  # Points for samples, coloured by nature
  geom_point(aes(colour = nature, shape = designation), size = 3) +
  # Labelled according to groundwater type
  scale_color_manual(values = c(Biofilm = "#08519c", Planktonic = "#9ecae1")) +
  scale_fill_manual(values = c(Biofilm = "#08519c", Planktonic = "#9ecae1")) +
  annotate('text', x = Inf, y = -Inf, size = 7/.pt, 
           label = paste('Stress = ', round(nmds$stress, digits = 2)),
           hjust = 1.1, vjust = -1, fontface = "bold"
           ) +
  ggrepel::geom_text_repel(aes(label = age), color = "black",
                  box.padding = 0.3, 
                  max.overlaps = 12,
                  min.segment.length = 0.5,
                  size = 7/.pt) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  theme_tidy(fontsize = 7) +
  theme(legend.spacing.x = unit(0.0, "mm"),
        plot.tag.position = c(.02,1.01)) -> b
```


```{r Fig. 3}
library(patchwork)
a + b + plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8, color = "black"))
```

```{r export Fig. 3}
ggsave("figures/fig_3.pdf", width = 18, height = 12, units = "cm")
ggsave("figures/fig_3.png", width = 18, height = 12, units = "cm")
```


Statistics on beta diversity: PERMANOVA


```{r permanova}
seqtab %>%
  select(-relab) %>%
  inner_join(smd[,c("sample","nature")], by = "sample") %>% 
  spread(seqid, count, fill = 0) %>%
  column_to_rownames("sample") -> t

vegan::adonis(t[,c(-1)] ~ nature, data = t)

seqtab %>%
  select(-relab) %>%
  inner_join(smd[,c("sample","env")], by = "sample") %>% 
  spread(seqid, count, fill = 0) %>%
  column_to_rownames("sample") -> t
  
pairwiseAdonis::pairwise.adonis(t[,c(-1)], factors = t$env)
```



## Fig. S2:  Bar plot DNA phylum


```{r bar plot DNA phylum}
cols <- c("Unidentified" = "#f0f0f0",
          'Other' = '#bdbdbd',
          'Alphaproteobacteria' = '#a6cee3',
          'Betaproteobacteria' = '#1f78b4',
          'Deltaproteobacteria' = '#b2df8a', 
          'Epsilonproteobacteria' = '#33a02c',
          'Gammaproteobacteria' = '#fb9a99',
          'Actinobacteria' = '#e31a1c', 
          'Bacteroidetes' = '#fdbf6f', 
          'Chloroflexi' = '#ff7f00',
          "Omnitrophicaeota" = '#cab2d6',
          'Patescibacteria' = '#6a3d9a', 
          'Spirochaetes' = '#b15928')

barplot() %>%
  mutate(env =  gsub("d", " d", env)) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75 d', 'TM-448.4 40 d', 'TM-448.4 20 d',
                                    'MM-171.3 75 d', 'MM-171.3 40 d', 'MM-171.3 20 d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Unidentified","Other",
                                             "Alphaproteobacteria",
                                             "Betaproteobacteria",
                                             "Deltaproteobacteria",
                                             "Epsilonproteobacteria",
                                             "Gammaproteobacteria")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  annotate(geom = "segment", x = .55, xend = 6.45, y = -.01, yend = -.01) +
  annotate(geom = "segment", x = 6.55, xend = 8.45, y = -.01, yend = -.01) +
  annotate('text', x = 3.5, y = -0.03, size = 7 / .pt, label = "Biofilm", angle = 90, hjust = 0.5, fontface = "bold") +
  annotate('text', x = 7.5, y = -0.03, size = 7 / .pt, label = "Planktonic", angle = 90, hjust = 0.5, fontface = "bold") +
  coord_flip(clip = "off") + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) +
  theme_barplot(ratio = 1.4, fontsize = 7) + 
  theme(legend.position = "right", axis.line.x = element_line())
```


```{r export barplot DNA phylum}
ggsave("figures/fig_s3.pdf", height = 10, width = 12, units = "cm")
ggsave("figures/fig_s3.png", height = 10, width = 12, units = "cm")
```


```{r barplot DNA order}
cols <- c("Unidentified" = "#f0f0f0",
          "Other" = "#bdbdbd",
          "Caulobacterales" = "#a6cee3",
          "Rhizobiales" = "#1f78b4", # Alpha
          "Burkholderiales" = "#fff5f0",
          "Nitrosomonadales" = "#fc9272", # Beta
          "Desulfobacterales" = "#b2df8a",
          "SAR324 clade" = "#33a02c",  # Delta
          "Campylobacterales" = "#cab2d6", # Epsilon
          "Pseudomonadales" = "#fdbf6f", # Gamma
          "Ca. Falkowbacteria" = "#6a3d9a",
          "Spirochaetales" = "#ffff99")

barplot(taxlevel = "order", n = 11) %>%
  mutate(env = gsub("d"," d", env)) %>%
  mutate(topphylum = if_else(topphylum == "SAR324 clade(Marine group B)", "SAR324 clade", topphylum)) %>%
  mutate(topphylum = if_else(topphylum == "Candidatus Falkowbacteria", "Ca. Falkowbacteria", topphylum)) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75 d', 'TM-448.4 40 d', 'TM-448.4 20 d',
                                    'MM-171.3 75 d', 'MM-171.3 40 d', 'MM-171.3 20 d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Unidentified","Other",
                                             "Caulobacterales","Rhizobiales",
                                             "Desulfobacterales","SAR324 clade",
                                             "Campylobacterales",
                                             "Burkholderiales","Nitrosomonadales","Pseudomonadales")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  coord_flip(clip = "off") + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) + 
  theme_barplot(ratio = 2.4, fontsize = 7) + 
  theme(legend.key.size = unit(3, "mm"),
        legend.spacing.x = unit(0, "mm"),
        legend.text = element_text(size = 7), 
        legend.box.margin = margin(0,0,0,0),
        legend.position = "left",
        axis.line.x = element_line(),
        axis.text.y = element_text(face = "bold"),
        plot.margin = margin(4,12,4,0),
        plot.tag.position = c(.1,1.02)) -> a
```


```{r barplot DNA genus}
cols <- c("Unidentified" = "#f0f0f0",
          "Other" = "#bdbdbd",
          "Brevundimonas" = "#a6cee3", # Caulobacterales (Alpha)
          "Hoeflea" = "#1f78b4", # Rhizobiales (Alpha)
          "Parvibaculum" = "#045a8d", # Parvibaculales (Alpha)
          "Ralstonia" = "#fff5f0", # Burkholderiales (Beta)
          "Methylotenera" = "#fee0d2", # Nitrosomonadales (Beta)
          "Thiobacillus" = "#fc9272", # Nitrosomonadales (Beta)
          "Desulfatiferula" = "#b2df8a", # Desulfobacterales (Delta)
          "Sulfurimonas" = "#cab2d6", # Campylobacterales (Epsilon)
          "Pseudomonas" = "#fdbf6f", # Pseudomonadales (Gamma)
          "Immundisolibacter" = "#ff7f00" # Immundisolibacterales (Gammaproteobacteria)
          )


barplot(taxlevel = "genus", n = 11) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75d', 'TM-448.4 40d', 'TM-448.4 20d',
                                    'MM-171.3 75d', 'MM-171.3 40d', 'MM-171.3 20d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Unidentified","Other",
                                             "Brevundimonas","Hoeflea","Parvibaculum",
                                             "Ralstonia","Thiobacillus",
                                             "Desulfatiferula","Methylotenera",
                                             "Pseudomonas",
                                             "Immundisolibacter","Sulfurimonas")
                                )
             )
         ) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  coord_flip(clip = "off") + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) +
  annotate(geom = "segment", x = .55, xend = 6.45, y = -.01, yend = -.01) +
  annotate(geom = "segment", x = 6.55, xend = 8.45, y = -.01, yend = -.01) +
  annotate('text', x = 3.5, y = -0.06, size = 7 / .pt, label = "Biofilm", angle = 90, hjust = 0.5, fontface = "bold") +
  annotate('text', x = 7.5, y = -0.06, size = 7 / .pt, label = "Planktonic", angle = 90, hjust = 0.5, fontface = "bold") +
  theme_barplot(ratio = 2.4, fontsize = 7) + 
  theme(legend.key.size = unit(3, "mm"), 
        legend.text = element_text(size = 7), 
        #legend.margin = margin(0,0,0,0),
        legend.box.margin = margin(0,0,0,0), 
        legend.position = "right",
        axis.line.x = element_line(),
        axis.text.y = element_blank(),
        plot.margin = margin(4,8,4,0),
        plot.tag.position = c(.1,1.02)) -> b
```


```{r Fig. 4}
library(patchwork)

a + b +
  plot_annotation(tag_levels = "a", tag_suffix = ")") +
  plot_layout(nrow = 1) &
  theme(plot.tag = element_text(size = 8, color = "black"), plot.tag.position = "top")
```


```{r export Fig. 4}
ggsave("figures/fig_4.pdf", height = 12, width = 18, units = "cm")
ggsave("figures/fig_4.png", height = 12, width = 18, units = "cm")
```


## Load gene counts, taxonomy and sample metadata


```{r read data, message=FALSE, warning=FALSE}
read_tsv('final.contigs.tsv', col_types = cols(.default = col_character(),
                                               count = col_integer()
                                               )
         )  -> rnatab

# Read taxonomy (Prokka)
read_tsv('prokka.tsv', col_types = cols(.default = col_character(),
                                        length_bp = col_integer()
                                        )
         ) %>% 
  rename(geneid = locus_tag) -> prokka
read_tsv('eggnogs.tsv', col_types = cols(.default = col_character())) -> eggnogs

# Taxonomy (NCBI)
read_tsv('taxa.tsv', col_types = cols(.default = col_character())) -> ncbi
```


## Fig. 5a: NMDS on Bray-Curtis dissimilarities (RNA)


Transform the genecounts



```{r run NMDS on RNA, results='hide'}
rnatab %>%
  select(geneid, sample, count) %>% spread(geneid, count, fill = 0) %>%
  column_to_rownames("sample") -> t

set.seed(999)
t %>%  vegan::metaMDS(trymax = 20, k = 2, autotransform = T) -> nmds
```

Extract the scores

```{r nmds.scores RNA}
vegan::scores(nmds)$sites %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(smd, by = "sample") -> nmds.scores
```

Plot the ordination

```{r NMDS plot RNA, include = T}
nmds.scores %>% select(1:3) %>% inner_join(smd, by = "sample") -> df

#getting the convex hull of each unique point set
find_hull <- function(df) df[chull(df$NMDS1, df$NMDS2), ]
hulls <- plyr::ddply(df, "nature", find_hull)

nmds.scores %>%
  ggplot(aes(x = NMDS1, y = NMDS2, fill = nature)) +
  geom_polygon(data = hulls,alpha = .3) +
  # Points for samples, coloured by nature
  geom_point(aes(colour = nature, shape = designation), size = 3) +
  # Labelled according to groundwater type
  scale_color_manual(values = c(Biofilm = "#08519c", Planktonic = "#9ecae1")) +
  scale_fill_manual(values = c(Biofilm = "#08519c", Planktonic = "#9ecae1")) +
  annotate('text', x = Inf, y = -Inf, size = 7/.pt, 
           label = paste('Stress = ', round(nmds$stress, digits = 2)),
           hjust = 1.1, vjust = -1, fontface = "bold",
           ) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  theme_tidy(fontsize = 7) +
  theme(legend.spacing.x = unit(0.0, "mm"),
        plot.margin = margin(0,8,0,0)) -> a
```


## Fig. 5b: Barplot mRNA

Transform absolute counts to counts per million (cpm) which is the relative abundance within each sample.


```{r calculate cpm from raw counts}
rnatab %>%
  filter(geneid %in% ncbi$geneid) %>%
  spread(sample, count, fill = 0) %>%
  column_to_rownames('geneid') %>%
  edgeR::DGEList(group = na.omit(smd$treat)) %>% edgeR::cpm() %>%
  as.data.frame() %>%
  rownames_to_column('geneid') %>%
  gather(sample, cpm , -1) %>% filter(cpm > 0) %>% 
  as_tibble() -> seqcpm
```


```{r select 11 most abundant orders RNA}
seqcpm %>%
  # Only use transcripts annotated on phylum level
  inner_join(ncbi, by = "geneid") %>%
  inner_join(smd, by = "sample") %>%
  group_by(order, env) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(12, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(phylum), "Unidentified", topphylum)) %>%
  mutate(topphylum = if_else(topphylum == "Proteobacteria", class, topphylum)) %>%
  replace_na(list("topphylum" = "Other")) -> taxref
```


```{r barplot mRNA order level}
cols <- c("Unidentified" = "#f0f0f0",
          "Other" = "#bdbdbd",
          "Rhizobiales" = "#1f78b4", # Alpha
          "Burkholderiales" = "#fff5f0", # Beta
          "Nitrosomonadales" = "#fc9272", # Beta
          "Rhodocyclales" = "#a50f15", # Beta
          "Desulfobacterales" = "#b2df8a", # Delta
          "Campylobacterales" = "#cab2d6", # Epsilon
          "Enterobacterales" = "#6a3d9a", # Gamma
          "Acholeplasmatales" = "#fdbf6f", # Firmicutes
          "Bacillales" = "#ff7f00", # Firmicutes
          "Clostridiales" = "#B35900", # Firmicutes
          "Methanobacteriales" = "#dfc27d",
          "Trichomonadida" = "#8c510a")

seqcpm %>%
  inner_join(taxref, by = "geneid") %>%
  # Combine water type and origin
  inner_join(smd, by = 'sample') %>%
  # Summarize in order to have the sum for each category and topphylum
  group_by(sample, topphylum) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  # Call plot
  ggplot(aes(x = fct_relevel(sample, c('P10152_S1','P10152_S4','P4056_101','P4056_102',
                                       'P10152_S3','P10152_S2')), 
             y = cpm, 
             fill = fct_relevel(topphylum, c('Unidentified','Other',
                                             "Rhizobiales",
                                             "Burkholderiales","Nitrosomonadales","Rhodocyclales",
                                             "Desulfobacterales",
                                             "Campylobacterales",
                                             "Enterobacterales",
                                             "Acholeplasmatales","Bacillales","Clostridiales"))
             )
         ) +
  labs(y = expression(bold('Counts per million (' %*% '1000)')), x = '') +
  scale_y_continuous(labels = c(expression(bold("1000")), 
                                expression(bold("750")), 
                                expression(bold("500")), 
                                expression(bold("250")), 
                                expression(bold("0"))), 
                     trans = 'reverse', expand = c(0.002,0)) +
  scale_x_discrete(labels = c("Biofilm\n2/2","Biofilm\n1/2","Planktonic\n2/2","Planktonic\n1/2",
                              "Biofilm\n2/2","Biofilm\n1/2","Planktonic\n2/2","Planktonic\nrep. 1/2")) +
  geom_col() +
  scale_fill_manual(values = cols) +
  coord_flip(clip = "off") + 
  annotate('text', x = 1, y = 400000, size = 6/.pt, label = "52% Thiobacillus", fontface = "bold") +
  #annotate('text', x = 6, y = 350000, size = 1.8, label = "37% Desulfobacteraceae", fontface = "bold") +
  annotate(geom = "segment", x = .55, xend = 4.45, y = -10000, yend = -10000) +
  annotate(geom = "segment", x = 4.55, xend = 8.45, y = -10000, yend = -10000) +
  annotate('text', x = 2.5, y = -40000, size = 7 / .pt, label = "TM-448.4", angle = 90, hjust = 0.5, fontface = "bold") +
  annotate('text', x = 6.5, y = -40000, size = 7 / .pt, label = "MM-171.3", angle = 90, hjust = 0.5, fontface = "bold") +
  theme_barplot(ratio = 1.2, fontsize = 7) + 
  guides(fill = guide_legend(nrow = 7)) +
  theme(legend.key.size = unit(3, "mm"),
        legend.text = element_text(size = 7),
        axis.line.x = element_line()) -> b
```


```{r Fig. 5}
library(patchwork)
a + b + plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8, color = "black"))
```

```{r export Fig. 5}
ggsave("figures/fig_5x.pdf", height = 12, width = 18, units = "cm")
ggsave("figures/fig_5x.png", height = 12, width = 18, units = "cm")
```


```{r PERMANOVA on Bray-Curtis dissimilarities RNA}
set.seed(999)

rnatab %>%
  inner_join(smd[,c("sample","nature")], by = "sample") %>% 
  spread(geneid, count, fill = 0) %>%
  column_to_rownames("sample") -> t

vegan::adonis(t[,c(-1)] ~ nature, data = t)
```


## Fig. 5: Differential gene expression using EdgeR


```{r differential expression}
library(edgeR)
rnatab %>% spread(sample, count, fill = 0) %>% column_to_rownames('geneid') -> d
DGEList(d, group = smd$treat %>% na.omit()) -> d

# Filter based on cpm
keep <- filterByExpr(d)
d <- d[keep, , keep.lib.sizes = F]
# TTM normalization to correct for compositional bias
calcNormFactors(d) -> d

# Design matrix based on experimental design
design.mat <- model.matrix(~ 0 + smd$treat)
rownames(design.mat) <- colnames(d)
colnames(design.mat) <- levels(d$samples$group)

# Estimate gene expression dispersion
d %>% estimateDisp(design = design.mat, robust = F) -> d
# Fit a GLM and run the test
fit <- glmFit(d, design = design.mat)

# Genes which baseline differences between planktonic and biofilm
i <- makeContrasts(mm = A-B, tm = C-D, levels = design.mat)

de_mm <- glmLRT(fit, contrast = i[, "mm"])
de_tm <- glmLRT(fit, contrast = i[, "tm"])
```


```{r extract data DE analysis}
de_mm_test <- decideTestsDGE(de_mm) %>% data.frame() %>% rename(diffexp = 1) %>% rownames_to_column("geneid")
de_tm_test <- decideTestsDGE(de_tm) %>% data.frame() %>% rename(diffexp = 1) %>% rownames_to_column("geneid")

de_mm$table %>% 
  rownames_to_column("geneid") %>% 
  inner_join(eggnogs, by = "geneid") %>% 
  mutate(aquifer = "MM-171.3") %>% 
  inner_join(de_mm_test, by = "geneid") -> de_mm
de_tm$table %>% 
  rownames_to_column("geneid") %>% 
  inner_join(eggnogs, by = "geneid") %>% 
  mutate(aquifer = "TM-448.4") %>%
  inner_join(de_tm_test, by = "geneid") -> de_tm

de_mm %>% rbind(de_tm) %>% as_tibble() -> diffexp

remove(de_mm, de_tm, de_mm_test, de_tm_test, d, design.mat, fit)
```


Fig. 6 and 7: please organise the y-axis according to function by grouping these categories, e.g., into "biofilm formation", "motility", "energy conservation", "transporters", "biosynthesis"... For the bar plot, the 11 most abundant taxonomic groups are selected (either phyla, classes or orders)


```{r prepare plot DE eggnogs}
cols <- c("Unidentified" = "#f0f0f0",
          "Other" = "#bdbdbd",
          "Rhizobiales" = "#1f78b4", # Alpha
          "Burkholderiales" = "#fff5f0", # Beta
          "Nitrosomonadales" = "#fc9272", # Beta
          "Rhodocyclales" = "#a50f15", # Beta
          "Desulfobacterales" = "#b2df8a", # Delta
          "Campylobacterales" = "#cab2d6", # Epsilon
          "Acholeplasmatales" = "#fdbf6f", # Tenericutes
          "Bacillales" = "#ff7f00", # Firmictues
          "Methanobacteriales" = "#dfc27d", 
          "Trichomonadida" = "#8c510a")

i <- c("Translation, ribosomal structure and biogenesis","Energy production and conversion",
       "Cell motility","Posttranslational modification, protein turnover, chaperones",
       "Amino acid transport and metabolism",
       "Replication, recombination and repair","Carbohydrate transport and metabolism",
       "Intracellular trafficking, secretion, and vesicular transport","Signal transduction mechanisms",
       "Cell wall/membrane/envelope biogenesis")

seqcpm %>%
  filter(geneid %in% diffexp$geneid) %>%
  inner_join(ncbi, by = "geneid") %>%
  group_by(order, sample) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(10, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(order), "Unidentified", topphylum)) %>%
  replace_na(list("topphylum" = "Other")) -> taxref
```


```{r plot significant DE eggnogs}
seqcpm %>%
  inner_join(diffexp, by = "geneid") %>% filter(diffexp != 0 & eggnog %in% i) %>%
  inner_join(taxref, by = 'geneid') %>%
  mutate(diffexp = if_else(diffexp == 1, "Planktonic", "Biofilm")) %>%
  mutate(aquifer = paste(aquifer, diffexp)) %>%
  group_by(topphylum, eggnog, aquifer) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  ggplot(aes(x = cpm, 
             y = fct_relevel(eggnog, i),
             fill = fct_relevel(topphylum, c('Unidentified','Other',
                                             "Rhizobiales",
                                             "Burkholderiales","Nitrosomonadales","Rhodocyclales",
                                             "Desulfobacterales",
                                             "Campylobacterales")) %>% fct_rev()
             )
         ) +
  labs(x = expression(bold('Counts per million (' %*% '1000)')), y = '') +
  facet_wrap(~ aquifer, nrow = 1, ncol = 4) +
  geom_col() +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = c(expression(bold("0")), 
                                "", 
                                expression(bold("100")),
                                "",
                                expression(bold("200")), 
                                ""), 
                     n.breaks = 5, expand = c(0.004,0)) +  
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme_tidy(ratio = 3.4) + 
  theme(panel.border = element_blank(),
        strip.background = element_rect(size = 0,fill = "#f0f0f0"),
        axis.ticks.y = element_blank(),
        legend.position = c(1,0.72),
        strip.text = element_text(face = "bold"),
        axis.text.y = element_text(face = "plain", size = 6, colour = "black"),
        axis.text.x = element_text(face = "bold", size = 6),
        legend.spacing.x = unit(0.5, "mm"),
        legend.box.margin = margin(0,0,0,0),
        legend.box.background = element_rect(size = .7, colour = "black"),
        legend.key.size = unit(3.3, "mm"),
        axis.line.x.bottom = element_line(colour = "black"))
```


```{r export plot DE eggnogs}
ggsave('figures/fig_6.pdf', height = 10, width = 16, units = 'cm')
ggsave('figures/fig_6.png', height = 10, width = 16, units = 'cm')
```


```{r fungi}
ncbi %>% 
  filter(kingdom == "Fungi") %>% 
  inner_join(seqcpm, by = "geneid") %>%
  mutate(rank = substr(rank, start = 1, stop = 1)) %>%
  mutate(taxon = paste(taxon, " (", rank, ")", sep = "")) %>%
  group_by(sample, taxon) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  #mutate(rank = substr(rank, start = 1, stop = 1)) %>%
  #mutate(taxon = paste(taxon, " (", rank, ")", sep = "")) %>%
  ggplot(aes(x = cpm, 
             y = fct_rev(fct_relevel(sample, c("P10152_S2","P10152_S3"))),
             fill = taxon)) +
  labs(x = 'Counts per million', y = '') +
  geom_col() +
  scale_fill_brewer(palette = 'Paired') +
  coord_cartesian(clip = "off") +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), expand = c(0.004,0)) +
  annotate(geom = "text", x = 8.25e3, y = 1, hjust = 0, size = 6/.pt, label = "TM planktonic") +
  annotate(geom = "text", x = 8.25e3, y = 2.5, hjust = 0, size = 6/.pt, label = "MM planktonic") +
  annotate(geom = "text", x = 8.25e3, y = 4.5, hjust = 0, size = 6/.pt, label = "TM biofilm") +
  annotate(geom = "text", x = 8.25e3, y = 6.5, hjust = 0, size = 6/.pt, label = "MM biofilm") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 0.55, yend = 1.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 1.55, yend = 3.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 3.55, yend = 5.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 5.55, yend = 7.45, lwd = 0.5, geom = "segment") +
  theme_clean(ratio = 1.4) +
  theme(legend.spacing.x = unit(0.5, "mm"),
        panel.grid.major.y = element_blank(),
        legend.key.size = unit(3.5, "mm"),
        axis.line.x.bottom = element_line(colour = "black")
  )
```


```{r export barplot fungi}
ggsave("figures/fig_s3.pdf", height = 10, width = 10, units = "cm")
ggsave("figures/fig_s3.png", height = 10, width = 10, units = "cm")
```


```{r prepare plot eggnogs}
cols <- c("Unidentified" = "#f0f0f0",
          "Other" = "#bdbdbd",
          "Rhizobiales" = "#1f78b4", # Alpha
          "Burkholderiales" = "#fff5f0", # Beta
          "Nitrosomonadales" = "#fc9272", # Beta
          "Rhodocyclales" = "#a50f15", # Beta
          "Desulfobacterales" = "#b2df8a", # Delta
          "Campylobacterales" = "#cab2d6", # Epsilon
          "Acholeplasmatales" = "#fdbf6f", # Tenericutes
          "Bacillales" = "#ff7f00", # Firmictues
          "Methanobacteriales" = "#dfc27d", 
          "Trichomonadida" = "#8c510a")

seqcpm %>%
  inner_join(ncbi, by = "geneid") %>%
  group_by(order, sample) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(10, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(order), "Unidentified", topphylum)) %>%
  replace_na(list("topphylum" = "Other")) -> taxref
```


```{r plot eggnogs orders}
seqcpm %>%
  inner_join(smd, by = "sample") %>%
  inner_join(taxref, by = 'geneid') %>%
  inner_join(eggnogs, by = "geneid") %>% filter(eggnog %in% i) %>%
  mutate(aquifer = paste(designation, nature)) %>%
  group_by(topphylum, eggnog, aquifer) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  ggplot(aes(x = cpm, 
             y = fct_relevel(eggnog, i),
             fill = fct_relevel(topphylum, c('Unidentified','Other',
                                             "Rhizobiales",
                                             "Burkholderiales","Nitrosomonadales","Rhodocyclales",
                                             "Desulfobacterales",
                                             "Campylobacterales")) %>% fct_rev()
             )
         ) +
  labs(x = expression(bold('Counts per million (' %*% '1000)')), y = '') +
  facet_wrap(~ aquifer, nrow = 1, ncol = 4) +
  geom_col() +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = c(expression(bold("0")),expression(bold("50")),expression(bold("100")),
                                expression(bold("150")), expression(bold("200"))), 
                    n.breaks = 5, expand = c(0.004,0)) +  
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme_tidy(ratio = 3.4) + 
  theme(panel.border = element_blank(),
        strip.background = element_rect(size = 0,fill = "#f0f0f0"),
        axis.ticks.y = element_blank(),
        legend.position = c(1,0.72),
        strip.text = element_text(face = "bold"),
        axis.text.y = element_text(face = "plain", size = 6, colour = "black"),
        axis.text.x = element_text(face = "bold", size = 6),
        legend.spacing.x = unit(0.5, "mm"),
        legend.box.margin = margin(0,0,0,0),
        legend.box.background = element_rect(size = .7, colour = "black"),
        legend.key.size = unit(3.3, "mm"),
        axis.line.x.bottom = element_line(colour = "black"))
```


```{r export plot eggnogs}
ggsave('figures/fig_s4.pdf', height = 10, width = 16, units = 'cm')
ggsave('figures/fig_s4.png', height = 10, width = 16, units = 'cm')
```


```{r Redox}
# Reduction
prokka %>%
  filter(EC_number %in% c("2.7.7.4","1.8.99.5") | 
           product %in% c("Adenylylsulfate reductase subunit alpha",
                          "Adenylylsulfate reductase subunit beta",
                          "Anaerobic sulfite reductase subunit A",
                          "Anaerobic sulfite reductase subunit B") | 
           COG %in% c("COG0243","COG4117","COG0243")) %>% 
  select(geneid, product) %>% 
  mutate(redox = "S red. / disp.") -> sulfur

# Oxidation
prokka %>% 
  filter(EC_number %in% c("2.7.7.4","2.8.5.2","1.8.2.3") |
           product %in% c("Sulfide-quinone reductase") |
           gene %in% c("soeA","soeB","soeC","sqr") |
           COG %in% c("COG3302")) %>% 
  select(geneid, product) %>% 
  mutate(redox = "S oxidation") %>%
  rbind(sulfur) %>%
  inner_join(seqcpm, by = "geneid") %>% 
  inner_join(smd, by = "sample") %>%
  group_by(sample, redox) %>%
  summarise(cpm = sum(cpm), .groups = "drop") -> sulfur

sulfur %>%
  inner_join(smd, by = "sample") %>%
  group_by(env, redox) %>%
  summarise(mean = sum(cpm) / 2, sd = sd(cpm), .groups = "drop") %>%
  ggplot(aes(x = mean, 
             y = fct_rev(env), 
             fill = redox, 
             group = redox)) +
  geom_errorbar(aes(xmin = mean-sd, xmax = mean+sd), 
                width = 0.2, colour = "black",
                position = position_dodge(0.5)) +
  geom_col(position = "dodge", width = .5) +
  labs(x = expression(bold('Counts per million (' %*% '1000)')), y = '') +
  scale_fill_manual(values = c("S red. / disp." = "#525252",
                               "S oxidation" = "#d9d9d9")) +
  scale_x_continuous(expand = c(0.004,0), n.breaks = 4,
                     limits = c(0,30000),
                     labels = c("0","10","20","30")) +
  theme_clean(ratio = 1.2, fontsize = 8) +
  theme(axis.title.y.left = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.key.size = unit(3.5, "mm"),
        legend.text = element_text(size = 8),
        legend.position = c(.8,.85))
```
```{r export redox}
ggsave('figures/fig_s5.pdf', height = 8.5, width = 8.5, units = 'cm')
ggsave('figures/fig_s5.png', height = 8.5, width = 8.5, units = 'cm')
```
