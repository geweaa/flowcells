---
title: "Flowcells Äspö HRL"
subtitle: "Biofilm formation in deep biosphere at Äspö HRL"
author: "George Westmeijer"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: spacelab
    highlight: textmate
    df_print: paged
    code_folding: hide
    self_contained: false
    keep_md: false
    encoding: "UTF-8"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
```


## Define theme and function(s)

```{r themes}
source("/Users/geweaa/Box Sync/Protocols/theme.R")
source("/Users/geweaa/Box Sync/Protocols/barplot.R")
```

## Read files


```{r input files, message=FALSE, warning=FALSE}
read_tsv('smd.tsv', col_types = cols(.default = col_character(),
                                     env = col_factor(levels = 
                                                        c("Planktonic MM-171.3","Biofilm MM-171.3",
                                                          "Planktonic TM-448.4","Biofilm TM-448.4")),
                                     treat = col_factor(levels = c(
                                       "A","B","C","D","0.1","0.2"
                                     ))
                                     )
         ) -> smd

read_tsv("taxonomy.tsv", col_types = cols(.default = col_character())) %>%
  mutate(order = if_else(order == "Betaproteobacteriales","Nitrosomonadales",order)) %>%
  mutate(family = if_else(family == "Hydrogenophilaceae","Thiobacillaceae",family)) %>%
  mutate(order = if_else(family == "Burkholderiaceae","Burkholderiales",order))-> tax

read_tsv('seqtab.tsv', col_types = cols(.default = col_character(), count = col_integer())) %>%
  # Filter out samples with less than 1000 reads
  group_by(sample) %>% filter(sum(count) > 1000) %>%
  # Calculate relative abundance within sample
  mutate(relab = count / sum(count)) %>% ungroup() %>%
  # Average the relative abundance within an environment by dividing by the total
  inner_join(smd, by = 'sample') %>%
  mutate(env = if_else(nature == "Planktonic", as.vector(env), paste(env,age))) %>%
  group_by(env) %>% mutate(relab = relab / sum(relab)) %>% ungroup() %>%
  select(sample, seqid, count, relab) -> seqtab
```


## Rarefaction


```{r rarefaction}
seqtab %>%
  inner_join(smd, by = 'sample') %>% mutate(nature = paste(nature, desig)) %>%
  group_by(nature, seqid) %>% summarise(count = sum(count), .groups = 'drop') %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames('nature') -> seqtab_matrix

min(rowSums(seqtab_matrix)) %>%
vegan::rarecurve(seqtab_matrix, sample = ., step = 100, xlab = 'Sequencing depth', ylab = 'Diversity (# ASVs)', label = TRUE)
```


## Alpha diversity using Shannon-Weaver index


```{r calculcate Shannon, message=FALSE, warning=FALSE}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>% column_to_rownames('sample') %>%
  vegan::diversity() %>% as.data.frame() %>% 
  gather(seqid, shannon, -1) %>%
  rename(shannon = 1) %>%
  rownames_to_column('sample') %>%
  inner_join(smd, by = "sample") %>% as_tibble() -> adiv
```


```{r statistics alpha diversity}
adiv %>% filter(designation == "TM-448.4") %>% group_by(env,treat,age) %>% summarise(meandiv = mean(shannon), .groups = "drop") -> stat

suppressPackageStartupMessages(library(car))
# Normality of the data (null hypothesis data is normally distributed)
shapiro.test(adiv$meandiv)
# Preferably all the dots on the diagonal
qqPlot(adiv$meandiv)
# Homogeneity of variance using Levene (null hypothesis variance is equal)
leveneTest(meandiv ~ env, data = adiv)
# Run ANOVA (null hypothesis diversity is equal)
aov(meandiv ~ env, data = stat) %>% summary()
# Post-hoc
aov(meandiv ~ env, data = adiv) %>% TukeyHSD()
```


Plot alpha diversity


```{r plot adiv}
adiv %>%
  mutate(age = if_else(nature == "Planktonic", "", gsub("d"," d", age))) %>%
  ggplot(aes(x = shannon, y = fct_rev(env))) +
  geom_boxplot() +
  geom_jitter(width = 0.01, stroke = 0.8, size = 1, fill = "white", shape = 21, height = 0.1) +
  labs(x = "Alpha diversity (Shannon index)", y = "") +
  scale_x_continuous(limits = c(1,6), expand = c(0.004,0), breaks = ) +
  scale_y_discrete(labels = c("Biofilm TM-448.4\nn = 6","Planktonic TM-448.4\nn = 12",
                              "Biofilm MM-171.3\nn = 6","Planktonic MM-171.3\nn = 12")) +
  ggrepel::geom_text_repel(aes(label = age), color = "black",
                  box.padding = 0.3, 
                  max.overlaps = 10,
                  min.segment.length = 0.4,
                  size = 6/.pt) +
  # Bracket TM-448.4
  #annotate(geom = "segment", lineend = "square", x = 5, xend = 5, y = 1, yend = 2) +
  #annotate(geom = "segment", lineend = "square", x = 4.9, xend = 5, y = 1, yend = 1) +
  #annotate(geom = "segment", lineend = "square", x = 4.9, xend = 5, y = 2, yend = 2) +
  #annotate(geom = "text", x = 5.2, y = 1.5, label = "ns", size = 6/.pt) +
  # Bracket MM-171.3
  #annotate(geom = "segment", lineend = "square", x = 5.7, xend = 5.7, y = 3, yend = 4) +
  #annotate(geom = "segment", lineend = "square", x = 5.6, xend = 5.7, y = 3, yend = 3) +
  #annotate(geom = "segment", lineend = "square", x = 5.6, xend = 5.7, y = 4, yend = 4) +
  #annotate(geom = "text", x = 5.9, y = 3.5, label = "ns", size = 6/.pt) +
  theme_clean(ratio = 1.6) +
  theme(plot.tag.position = c(.2,1.01),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype = "dotted", color = "grey", size = 0.3),
        axis.text.y.left = element_text(face = "plain", hjust = 0.5))  -> a
```


## Fig. 1b: PCA on Hellinger-transformed dataset DNA


Hellinger transform the absolute counts


```{r run PCA}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames("sample") %>%
  vegan::decostand(method = 'hellinger') %>%
  rownames_to_column('sample') %>%
  gather(seqid, hellinger, -1) %>%
  filter(hellinger > 0) %>%
  mutate(hellinger = as.numeric(hellinger)) %>%
  spread(seqid, hellinger, fill = 0) %>%
  column_to_rownames('sample') %>% 
  vegan::rda() -> pca
```


```{r Extract PCA values}
pca.samples <- pca$CA$u %>% data.frame() %>% tibble::rownames_to_column('sample')
pca.geneid    <- pca$CA$v %>% data.frame() %>% tibble::rownames_to_column('seqid')
pca.eigs    <- pca$CA$eig %>% data.frame() %>% tibble::rownames_to_column('pc') %>%
  rename(eigval = 2) %>%
  mutate(propexpl = eigval/sum(eigval))
```


```{r Plot PCA}
pca.samples %>% select(1:3) %>% inner_join(smd, by = "sample") -> df

#getting the convex hull of each unique point set
find_hull <- function(df) df[chull(df$PC1, df$PC2), ]
hulls <- plyr::ddply(df, "nature", find_hull)

pca.samples %>%
  inner_join(smd, by = 'sample') %>%
  mutate(age = if_else(nature == "Planktonic", "", gsub("d"," d",age))) %>%
  ggplot(aes(x = PC1, y = PC2, fill = nature)) +
  geom_polygon(data = hulls,alpha = .3) +
  # Points for samples, coloured by nature
  geom_point(aes(colour = nature, shape = designation), size = 3) +
  # Labelled according to groundwater type
  scale_color_grey() + 
  scale_fill_grey() +
  ggrepel::geom_text_repel(aes(label = age), color = "black",
                  box.padding = 0.3, 
                  max.overlaps = 12,
                  min.segment.length = 0.5,
                  size = 6/.pt) +
  #geom_text(aes(label = age), size = 6/.pt, hjust = -0.5) +
  xlab(sprintf("PC1 (%2.1f%% explained)", pca.eigs[1,3] * 100)) +
  ylab(sprintf("PC2 (%2.1f%% explained)", pca.eigs[2,3] * 100)) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  theme_tidy() +
  theme(legend.spacing.x = unit(0.0, "mm"),
        plot.tag.position = c(.02,1.01)) -> b
```


```{r Fig. 1}
library(patchwork)
a + b + plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8, color = "black"))
```

```{r export Fig. 1}
ggsave("figures/fig_1.pdf", width = 16, height = 10, units = "cm")
ggsave("figures/fig_1.png", width = 16, height = 10, units = "cm")
```


Statistics on beta diversity: PERMANOVA


```{r permanova}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames("sample") %>%
  vegan::decostand(method = 'hellinger') %>%
  pairwiseAdonis::pairwise.adonis(factors = smd$env, sim.method = 'euclidean')
```



## Fig. 2:  Bar plot DNA


```{r bar plot DNA phylum}
cols <- c('Other' = '#A6CEE3', 'Actinobacteria' = '#569EA4', 'Alphaproteobacteria' = '#AADB84',
'Bacteroidetes' = '#52AF43', 'Chloroflexi' = '#F88A89',
'Deltaproteobacteria' = '#E73233', 'Epsilonbacteraeota' = '#fdbf6f',
'Firmicutes' = '#fccde5', 'Gammaproteobacteria' = '#bc80bd', "Omnitrophicaeota" = '#3D3F99',
'Patescibacteria' = '#ffff99', 'Spirochaetes' = '#b15928')

barplot() %>%
  mutate(topphylum = if_else(topphylum == "SAR324 clade(Marine group B)", "SAR324 clade", topphylum)) %>%
  mutate(env =  gsub(" after", "", env)) %>%
  mutate(env =  gsub(" before", "", env)) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75d', 'TM-448.4 40d', 'TM-448.4 20d',
                                    'MM-171.3 75d', 'MM-171.3 40d', 'MM-171.3 20d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Other")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  annotate(geom = "segment", x = .55, xend = 6.45, y = -.01, yend = -.01) +
  annotate(geom = "segment", x = 6.55, xend = 8.45, y = -.01, yend = -.01) +
  annotate('text', x = 3.5, y = -0.03, size = 6 / .pt, label = "Biofilm", angle = 90, hjust = 0.5) +
  annotate('text', x = 7.5, y = -0.03, size = 6 / .pt, label = "Planktonic", angle = 90, hjust = 0.5) +
  coord_flip() + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0')) +
  theme_barplot(ratio = 1.4) + theme(legend.position = "right") #+
  guides(fill = guide_legend(nrow = 3))
```


```{r export barplot DNA phylum}
ggsave("figures/fig_sx.pdf", height = 10, width = 12, units = "cm")
ggsave("figures/fig_sx.png", height = 10, width = 12, units = "cm")
```

```{r}
# Ralstonia (Burkholderiales), Immundisolibacter (Immundisolibacterales), Sulfurimonas (Campylobacterales),
# Brevundimonas (Caulobacterales), Desulfatiferula (Desulfobacterales), Methylotenera (Nitrosomonadales),
# Pseudomonas (Pseudomonadales), Hoeflea (Rhizobiales), Parvibaculum (Parvibaculales), 
# Thiobacillus (Nitrosomonadales), Acidiphilium (Acetobacterales)

cols <- c("Other" = "#a6cee3", "Ralstonia" = "#1f78b4","Immundisolibacter" = "#045a8d",
          "Sulfurimonas" = "#33a02c", "Brevundimonas" = "#fb9a99", "Desulfatiferula" = "#e31a1c",
          "Methylotenera" = "#a50f15","Thiobacillus" = "#fdbf6f","Parvibaculum" = "#ff7f00", 
          "Pseudomonas" = "#efedf5", "Hoeflea" = "#cab2d6",
          "Acidiphilium" = "#807dba")

barplot(taxlevel = "genus", n = 12) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75d', 'TM-448.4 40d', 'TM-448.4 20d',
                                    'MM-171.3 75d', 'MM-171.3 40d', 'MM-171.3 20d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Other","Ralstonia","Immundisolibacter","Sulfurimonas",
                                             "Brevundimonas","Desulfatiferula","Methylotenera","Thiobacillus",
                                             "Parvibaculum","Pseudomonas",
                                             "Hoeflea","Acidiphilium")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  coord_flip() + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) + 
  theme_barplot(ratio = 2) + 
  theme(legend.key.size = unit(3, "mm"), legend.text = element_text(size = 6), legend.margin = margin(0,0,0,0),
        legend.box.margin = margin(0,0,0,0), legend.box.spacing = unit(0, "mm"),
        legend.position = "left",
        axis.line.x = element_line(),
        axis.text.y = element_text(face = "bold"),
        plot.margin = margin(4,5,4,0),
        plot.tag.position = c(.1,1.02)) -> a
```


```{r lollipop}
seqtab %>%
  inner_join(smd, by = "sample") %>%
  mutate(env = ifelse(nature == "Planktonic", designation, paste(designation,age))) %>%
  inner_join(tax, by = "seqid") %>%
  group_by(env, genus) %>% summarise(relab = sum(relab) * 100, .groups = "drop_last") %>%
  filter(!is.na(genus) & genus != "uncultured bacterium" & genus != "uncultured") %>%
  slice_max(order_by = relab, n = 1) %>% ungroup() %>%
  mutate(hjust = if_else(relab >= 70, 1.07, -0.09)) %>%
  mutate(relab = round(relab, digits = 0)) %>%
  mutate(genus = paste(genus," (",relab,"%)", sep = "")) %>%
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75d', 'TM-448.4 40d', 'TM-448.4 20d',
                                    'MM-171.3 75d', 'MM-171.3 40d', 'MM-171.3 20d',
                                    'TM-448.4', 'MM-171.3')), 
             y = relab)) +
  geom_segment(aes(xend = env, y = 0, yend = relab), color = "black", size = 0.3) +
  geom_point(stroke = 0.8, size = 2, fill = "white", shape = 21) +
  geom_label(aes(label = genus, hjust = hjust), 
            color = "black", fontface = "plain", size = 1.8, label.size = 0.1, label.padding = unit(0.10, "lines")) +
  coord_flip() +
  scale_y_continuous(expand = c(0.004,0), limits = c(0,100), breaks = c(0,50,100), labels = c("0","50","100")) +
  labs(x = "", y = "Relative abundance (%)") +
  theme_clean(ratio = 2.5) +
  theme(panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(4,5,4,0),
        plot.tag.position = c(.1,1.02)) -> b
```


```{r bar plot DNA order}
cols <- c("Other" = "#a6cee3", "Burkholderiales" = "#1f78b4", "Ca. Falkowbacteria" = "#b2df8a",
          "Campylobacterales" = "#33a02c", "Caulobacterales" = "#fb9a99", "Desulfobacterales" = "#e31a1c",
          "Nitrosomonadales" = "#fdbf6f","Parvibaculales" = "#ff7f00", "Pseudomonadales" = "#efedf5", "Rhizobiales" = "#cab2d6",
          "SAR324 clade" = "#6a3d9a", "Spirochaetales" = "#ffff99")

barplot(taxlevel = "order", n = 12) %>%
  mutate(topphylum = if_else(topphylum == "SAR324 clade(Marine group B)", "SAR324 clade", topphylum)) %>%
  mutate(topphylum = if_else(topphylum == "Candidatus Falkowbacteria", "Ca. Falkowbacteria", topphylum)) %>%
  # Call the plot
  ggplot(aes(x = fct_relevel(env, c('TM-448.4 75d', 'TM-448.4 40d', 'TM-448.4 20d',
                                    'MM-171.3 75d', 'MM-171.3 40d', 'MM-171.3 20d',
                                    'TM-448.4', 'MM-171.3')),
             y = relab, 
             fill = fct_relevel(topphylum, c("Other")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col(width = 0.9) +
  scale_fill_manual(values = cols) +
  annotate(geom = "segment", x = .55, xend = 6.45, y = -.01, yend = -.01) +
  annotate(geom = "segment", x = 6.55, xend = 8.45, y = -.01, yend = -.01) +
  annotate('text', x = 3.5, y = -0.06, size = 6 / .pt, label = "Biofilm", angle = 90, hjust = 0.5) +
  annotate('text', x = 7.5, y = -0.06, size = 6 / .pt, label = "Planktonic", angle = 90, hjust = 0.5) +
  coord_flip(clip = "off") + 
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) + 
  theme_barplot(ratio = 2) + 
  theme(legend.key.size = unit(3, "mm"), legend.text = element_text(size = 6), legend.box.margin = margin(0,0,0,0),
        legend.position = "right",
        axis.line.x = element_line(),
        axis.text.y = element_blank(),
        plot.margin = margin(4,0,4,0),
        plot.tag.position = c(.1,1.02)) -> c
```


```{r Fig. 2}
library(patchwork)

a + b + c +
  plot_annotation(tag_levels = "a", tag_suffix = ")") +
  plot_layout(nrow = 1) &
  theme(plot.tag = element_text(size = 8, color = "black"), plot.tag.position = "top")
```


```{r export Fig. 2}
ggsave("figures/fig_2.pdf", height = 10, width = 18, units = "cm")
ggsave("figures/fig_2.png", height = 10, width = 18, units = "cm")
```


## Load gene counts, taxonomy and sample metadata


```{r read data, message=FALSE, warning=FALSE}
read_tsv('final.contigs.tsv') %>%
  select(-Start, -Length, -End, -Strand, -Chr) %>%
  rename(geneid = Geneid) %>%
  gather(sample, count, -1) %>% filter(count > 0) %>%
  mutate(sample = gsub('.pe.bowtie2.sorted.bam', '', sample)) %>%
  mutate(count = as.integer(count)) -> rnatab

# Read taxonomy (Prokka)
read_tsv('prokka.tsv') %>% rename(geneid = locus_tag) -> prokka
read_tsv('eggnogs.tsv', col_types = cols(.default = col_character())) -> eggnogs

# Read sample metadata
smd %>% 
  filter(is.na(age)) %>% 
  select(-age) %>%
  mutate(treat = factor(treat, levels = c("A","B","C","D")))-> smd

# Taxonomy (NCBI)
read_tsv('taxa.tsv', col_types = cols(.default = col_character())) -> ncbi
```


## Fig. 4a: PCA on Hellinger-transformed dataset


Transform the genecounts


```{r run PCA RNA}
rnatab %>%
  # Vegan transformation
  spread(geneid, count, fill = 0) %>%
  column_to_rownames("sample") %>%
  vegan::decostand(method = 'hellinger') %>%
  vegan::rda() -> pca
```


```{r Extract PCA RNA values}
pca.samples <- pca$CA$u %>% data.frame() %>% tibble::rownames_to_column('sample')
pca.geneid    <- pca$CA$v %>% data.frame() %>% tibble::rownames_to_column('geneid')
pca.eigs    <- pca$CA$eig %>% data.frame() %>% tibble::rownames_to_column('pc') %>%
  rename(eigval = 2) %>%
  mutate(propexpl = eigval/sum(eigval))
```


```{r Plot PCA RNA}
pca.samples %>%
  inner_join(smd, by = 'sample') %>%
  ggplot(aes(x = PC1, y = PC2)) +
  # Points for samples, coloured by nature
  geom_point(aes(colour = nature, shape = designation), size = 3) +
  scale_color_grey() +
  xlab(sprintf("PC1 (%2.1f%% explained)", pca.eigs[1,3] * 100)) +
  ylab(sprintf("PC2 (%2.1f%% explained)", pca.eigs[2,3] * 100)) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  theme_tidy() +
  theme(legend.spacing.x = unit(-0.5, "mm")) -> a
```

## Fig. 4b: Barplot mRNA

Transform absolute counts to counts per million (cpm) which is the relative abundance within each sample.


```{r calculate cpm from raw counts}
rnatab %>%
  filter(geneid %in% ncbi$geneid) %>%
  spread(sample, count, fill = 0) %>%
  column_to_rownames('geneid') %>%
  edgeR::DGEList(group = smd$treat) %>% edgeR::cpm() %>%
  as.data.frame() %>%
  rownames_to_column('geneid') %>%
  gather(sample, cpm , -1) %>% filter(cpm > 0) %>% 
  as_tibble() -> seqcpm
```


```{r select 11 most abundant phyla RNA}
seqcpm %>%
  # Only use transcripts annotated on phylum level
  inner_join(ncbi, by = "geneid") %>%
  inner_join(smd, by = "sample") %>%
  group_by(order, env) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(12, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(phylum), "Unidentified", topphylum)) %>%
  mutate(topphylum = if_else(topphylum == "Proteobacteria", class, topphylum)) %>%
  replace_na(list("topphylum" = "Other")) -> taxref
```


```{r barplot mRNA phylum level}
cols <- c("Other" = "#a6cee3", "Unidentified" = "#d9d9d9",
          "Acholeplasmatales" = "#969696", "Bacillales" = "#b15928", "Burkholderiales" = "#1f78b4",
          "Campylobacterales" = "#33a02c", "Clostridiales" = "#b2df8a", "Desulfobacterales" = "#e31a1c",
          "Enterobacterales" = "#fb9a99", "Methanobacteriales" = "#ff7f00",
          "Nitrosomonadales" = "#fdbf6f", "Rhizobiales" = "#cab2d6",
          "Rhodocyclales" = "#6a3d9a", "Trichomonadida" = "#ffff99")

seqcpm %>%
  inner_join(taxref, by = "geneid") %>%
  # Combine water type and origin
  inner_join(smd, by = 'sample') %>%
  # Summarize in order to have the sum for each category and topphylum
  group_by(env, topphylum) %>% summarise(cpm = sum(cpm) / 2, .groups = "drop") %>%
  mutate(topphylum = gsub("proteobacteria", "proteob.", topphylum)) %>%
  # Call plot
  ggplot(aes(x = fct_rev(env), 
             y = cpm, 
             fill = fct_relevel(topphylum, c('Other', 'Unidentified')))) +
  labs(y = expression(bold('Counts per million (' %*% '1000)')), x = '') +
  scale_y_continuous(labels = c(expression(bold("1000")), expression(bold("750")), expression(bold("500")), expression(bold("250")), expression(bold("0"))), 
                     trans = 'reverse', expand = c(0.002,0)) +
  scale_x_discrete(labels = c("Biofilm 75 d\nTM-448.4","Planktonic\nTM-448.4",
                              "Biofilm 75 d\nMM-171.3","Planktonic\nMM-171.3")) +
  geom_col() +
  scale_fill_manual(values = cols) +
  coord_flip() + 
  annotate('text', x = 1, y = 430000, size = 2, label = "41% Thiobacillaceae") +
  annotate('text', x = 3, y = 430000, size = 2, label = "34% Desulfobacteraceae") +
  theme_barplot(ratio = 1) + 
  guides(fill = guide_legend(nrow = 5)) +
  theme(legend.key.size = unit(3.3, "mm"),
        axis.line.x = element_line()) -> b
```


```{r Fig. 4}
library(patchwork)
a + b + plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8, color = "black"))
```

```{r export Fig. 4}
ggsave("figures/fig_4.pdf", height = 10, width = 16, units = "cm")
ggsave("figures/fig_4.png", height = 10, width = 16, units = "cm")
```


```{r Fig. 5 barplot biofilm order level eggnog}
i <- c("Translation, ribosomal structure and biogenesis","Cell wall/membrane/envelope biogenesis",
       "Energy production and conversion","Cell motility","Posttranslational modification, protein turnover, chaperones","Signal transduction mechanisms",
       "Amino acid transport and metabolism",
       "Replication, recombination and repair","Carbohydrate transport and metabolism",
       "Cytoskeleton")

cols <- c("Other" = "#a6cee3","Unidentified" = "#d9d9d9", "Burkholderiales" = "#1f78b4",
          "Campylobacterales" = "#33a02c", "Chromatiales" = "#fb9a99", "Desulfobacterales" = "#e31a1c",
          "Desulfovibrionales" = "grey",
          "Nitrosomonadales" = "#fdbf6f", "Pseudomonadales" = "#ff7f00", "Rhizobiales" = "#cab2d6",
          "Rhodocyclales" = "#6a3d9a", "Sphingomonadales" = "#ffff99")

seqcpm %>%
  inner_join(ncbi, by = "geneid") %>%
  group_by(order, sample) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(10, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(order), "Unidentified", topphylum)) %>%
  replace_na(list("topphylum" = "Other")) %>%
  inner_join(eggnogs, by = "geneid") -> taxref

seqcpm %>%
  inner_join(taxref, by = 'geneid') %>% 
  inner_join(smd, by = 'sample') %>% filter(nature == "Biofilm") %>%
  filter(eggnog %in% i) %>%
  group_by(topphylum, eggnog, env) %>% summarise(cpm = sum(cpm), .groups = 'drop') %>%
  # Call plot
  ggplot(aes(x = cpm, 
             y = fct_relevel(eggnog, i),
             fill = fct_relevel(topphylum, c('Other')))) +
  labs(x = 'Counts per million', y = '') +
  facet_wrap(~ env, labeller = label_wrap_gen(width = 40)) +
  geom_col() +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = c(0, expression(0.5 %*% 10^5), expression(10^5),
                                expression(1.5 %*% 10^5),""), n.breaks = 6, expand = c(0.002,0)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme_tidy(ratio = 2.0) + 
  theme(panel.border = element_blank(),
        legend.position = c(.9,.7),
        strip.text = element_text(face = "bold"),
        axis.text.y = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "bold"),
        legend.spacing.x = unit(0.5, "mm"),
        legend.key.size = unit(3.5, "mm"),
        axis.ticks.y.left = element_line(),
        axis.line.x.bottom = element_line(colour = "black"),
        axis.line.y.left = element_line(colour = "black"))

seqcpm %>%
  inner_join(taxref, by = 'geneid') %>%
  filter(eggnog %in% i) %>%
  inner_join(smd, by = "sample") %>%
  mutate(designation = paste(designation,nature)) %>%
  group_by(topphylum, eggnog, designation) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  ggplot(aes(x = cpm, 
             y = fct_relevel(eggnog, i),
             fill = fct_relevel(topphylum, c('Other','Unidentified')) %>% fct_rev()
             )
         ) +
  labs(x = expression(bold('Counts per million (' %*% '1000)')), y = '') +
  facet_wrap(~ designation, nrow = 1, ncol = 4) +
  geom_col() +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = c("0","50","100","150",""), n.breaks = 5, expand = c(0.004,0)) +  
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme_tidy(ratio = 3.4) + 
  theme(panel.border = element_blank(),
        strip.background = element_rect(size = 0,fill = "#f0f0f0"),
        axis.ticks.y = element_blank(),
        legend.position = c(1,0.72),
        strip.text = element_text(face = "bold"),
        axis.text.y = element_text(face = "plain", size = 6, colour = "black"),
        axis.text.x = element_text(face = "bold", size = 6),
        legend.spacing.x = unit(0.5, "mm"),
        legend.box.margin = margin(0,0,0,0),
        legend.box.background = element_rect(size = .7, colour = "black"),
        legend.key.size = unit(3.3, "mm"),
        axis.line.x.bottom = element_line(colour = "black"))
```


```{r Fig. 5 export barplot eggnog}
ggsave("figures/fig_5.pdf", height = 10, width = 16, units = "cm")
ggsave("figures/fig_5.png", height = 10, width = 16, units = "cm")
```


## Fig. 7: Differential gene expression using EdgeR


```{r differential expression}
library(edgeR)
rnatab %>% spread(sample, count, fill = 0) %>% column_to_rownames('geneid') -> d
DGEList(d, group = smd$treat) -> d

# Filter based on cpm
keep <- filterByExpr(d)
d <- d[keep, , keep.lib.sizes = F]
# TTM normalization to correct for compositional bias
calcNormFactors(d) -> d

# Design matrix based on experimental design
design.mat <- model.matrix(~ 0 + smd$treat)
rownames(design.mat) <- colnames(d)
colnames(design.mat) <- levels(d$samples$group)

# Estimate gene expression dispersion
d %>% estimateDisp(design = design.mat, robust = F) -> d
# Fit a GLM and run the test
fit <- glmFit(d, design = design.mat)

# Genes which baseline differences between planktonic and biofilm
i <- makeContrasts(mm = A-B, tm = C-D, levels = design.mat)

de_mm <- glmLRT(fit, contrast = i[, "mm"])
de_tm <- glmLRT(fit, contrast = i[, "tm"])
```


```{r extract data DE analysis}
de_mm_test <- decideTestsDGE(de_mm) %>% data.frame() %>% rename(diffexp = 1) %>% rownames_to_column("geneid")
de_tm_test <- decideTestsDGE(de_tm) %>% data.frame() %>% rename(diffexp = 1) %>% rownames_to_column("geneid")

de_mm$table %>% 
  rownames_to_column("geneid") %>% 
  inner_join(eggnogs, by = "geneid") %>% 
  mutate(aquifer = "MM-171.3") %>% 
  inner_join(de_mm_test, by = "geneid") -> de_mm
de_tm$table %>% 
  rownames_to_column("geneid") %>% 
  inner_join(eggnogs, by = "geneid") %>% 
  mutate(aquifer = "TM-448.4") %>%
  inner_join(de_tm_test, by = "geneid") -> de_tm

de_mm %>% rbind(de_tm) %>% as_tibble() -> diffexp

remove(de_mm, de_tm, de_mm_test, de_tm_test, d, design.mat, fit)
```


Fig. 6 and 7: please organise the y-axis according to function by grouping these categories, e.g., into "biofilm formation", "motility", "energy conservation", "transporters", "biosynthesis"... For the bar plot, the 11 most abundant taxonomic groups are selected (either phyla, classes or orders)


```{r prepare bar plot significant DE transcripts eggnog}
cols <- c("Other" = "#a6cee3", "Unidentified" = "#d9d9d9",
          "Acholeplasmatales" = "#969696", "Bacillales" = "#b15928", "Burkholderiales" = "#1f78b4",
          "Campylobacterales" = "#33a02c", "Desulfobacterales" = "#e31a1c",
          "Methanobacteriales" = "#ff7f00",
          "Nitrosomonadales" = "#fdbf6f", "Rhizobiales" = "#cab2d6",
          "Rhodocyclales" = "#6a3d9a", "Trichomonadida" = "#ffff99")

i <- c("Translation, ribosomal structure and biogenesis","Cell wall/membrane/envelope biogenesis",
       "Energy production and conversion","Cell motility","Posttranslational modification, protein turnover, chaperones","Signal transduction mechanisms",
       "Amino acid transport and metabolism",
       "Replication, recombination and repair","Carbohydrate transport and metabolism",
       "Cytoskeleton")

seqcpm %>%
  filter(geneid %in% diffexp$geneid) %>%
  inner_join(ncbi, by = "geneid") %>%
  group_by(order, sample) %>%
  # Sum the abundance of each phylum within a category
  summarise(cpm = sum(cpm), .groups = "drop_last") %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(cpm), .groups = 'drop') %>%
  filter(!is.na(order)) %>%
  top_n(10, mean_relab) -> t

ncbi %>%
  left_join(t %>% transmute(order, topphylum = order), by = "order") %>%
  mutate(topphylum = if_else(is.na(order), "Unidentified", topphylum)) %>%
  replace_na(list("topphylum" = "Other")) -> taxref
```


```{r bar plot significant DE transcripts eggnog}
seqcpm %>%
  inner_join(diffexp, by = "geneid") %>% filter(diffexp != 0 & eggnog %in% i) %>%
  inner_join(taxref, by = 'geneid') %>%
  mutate(diffexp = if_else(diffexp == 1, "Planktonic", "Biofilm")) %>%
  mutate(aquifer = paste(aquifer, diffexp)) %>%
  group_by(topphylum, eggnog, aquifer) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  ggplot(aes(x = cpm, 
             y = fct_relevel(eggnog, i),
             fill = fct_relevel(topphylum, c('Other','Unidentified')) %>% fct_rev()
             )
         ) +
  labs(x = expression(bold('Counts per million (' %*% '1000)')), y = '') +
  facet_wrap(~ aquifer, nrow = 1, ncol = 4) +
  geom_col() +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = c(expression(bold("0")), 
                                "", 
                                expression(bold("100")),
                                "",
                                expression(bold("200")), 
                                ""), 
                     n.breaks = 5, expand = c(0.004,0)) +  
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme_tidy(ratio = 3.4) + 
  theme(panel.border = element_blank(),
        strip.background = element_rect(size = 0,fill = "#f0f0f0"),
        axis.ticks.y = element_blank(),
        legend.position = c(1,0.72),
        strip.text = element_text(face = "bold"),
        axis.text.y = element_text(face = "plain", size = 6, colour = "black"),
        axis.text.x = element_text(face = "bold", size = 6),
        legend.spacing.x = unit(0.5, "mm"),
        legend.box.margin = margin(0,0,0,0),
        legend.box.background = element_rect(size = .7, colour = "black"),
        legend.key.size = unit(3.3, "mm"),
        axis.line.x.bottom = element_line(colour = "black"))
```


```{r export barplot edger significant DE}
ggsave('figures/fig_7.pdf', height = 10, width = 16, units = 'cm')
ggsave('figures/fig_7.png', height = 10, width = 16, units = 'cm')
```


```{r fungi}
ncbi %>% 
  filter(kingdom == "Fungi") %>% 
  inner_join(seqcpm, by = "geneid") %>%
  group_by(sample, taxon) %>% summarise(cpm = sum(cpm), .groups = "drop") %>%
  ggplot(aes(x = cpm, 
             y = fct_rev(fct_relevel(sample, c("P10152_S2","P10152_S3"))),
             fill = taxon)) +
  labs(x = 'Counts per million', y = '') +
  geom_col() +
  scale_fill_brewer(palette = 'Paired') +
  coord_cartesian(clip = "off") +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE)) +
  theme_tidy() +
  geom_text(aes(label = "TM planktonic", x = 8.25e3, y = 1), hjust = 0, size = 2.0) +
  geom_text(aes(label = "MM planktonic", x = 8.25e3, y = 2.5), hjust = 0, size = 2.0) +
  geom_text(aes(label = "TM biofilm", x = 8.25e3, y = 4.5), hjust = 0, size = 2.0) +
  geom_text(aes(label = "MM biofilm", x = 8.25e3, y = 6.5), hjust = 0, size = 2.0) +
  annotate(x = 8.2e3, xend = 8.2e3, y = 0.55, yend = 1.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 1.55, yend = 3.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 3.55, yend = 5.45, lwd = 0.5, geom = "segment") +
  annotate(x = 8.2e3, xend = 8.2e3, y = 5.55, yend = 7.45, lwd = 0.5, geom = "segment") +
  theme(panel.border = element_blank(),
        legend.spacing.x = unit(0.5, "mm"),
        legend.key.size = unit(4.0, "mm"),
        axis.text.y = element_text(size = 6.0),
        axis.ticks.y.left = element_line(),
        axis.line.x.bottom = element_line(colour = "black"),
        axis.line.y.left = element_line(colour = "black"))
```


```{r export barplot fungi}
ggsave("figures/fungi.pdf", height = 12, width = 14, units = "cm")
ggsave("figures/fungi.png", height = 12, width = 14, units = "cm")
```

```{r}
seqtab %>%
  # Filter out very low abundant ASVs
  group_by(seqid) %>% filter(count > 10) %>% ungroup() %>%
  select(-relab) %>% spread(sample, count, fill = 0) %>%
  column_to_rownames('seqid') %>%
  ALDEx2::aldex(conditions = smd %>% arrange(sample) %>% filter(!is.na(age)) %>% pull(nature)) %>%
  rownames_to_column("seqid") %>%
  inner_join(tax) -> aldex
```

